---
kind: pipeline
type: docker
name: Default

trigger:
  event:
    - push
    - tag

steps:

  - name: Audit
    image: node:12
    commands:
      - npm audit --package-lock-only --production --audit-level=moderate

  - name: Install
    image: node:12
    environment:
      NPM_CONFIG_IGNORE_SCRIPTS: true
    commands:
      - npm ci

  - name: Test
    image: node:12
    commands:
      - npm test

  # Disabled because the original code didn't have coverage checking at all and tests aren't very comprehensive
  #- name: check-coverage
  #  image: node:12
  #  commands:
  #    - npm run coverage

  - name: Build
    image: node:12
    commands:
      - npm run build
      - npm ci --production

  - name: Static-security-scan
    image: quay.io/natlibfi/njsscan
    commands:
      - njsscan dist

  - name: Npm
    image: plugins/npm
    settings:
      registry: 'https://registry.npmjs.org/'
      token:
        from_secret: npm_token
    when:
      event: tag
---
kind: pipeline
type: docker
name: Update dependencies

trigger:
  event:
    - custom
  branch:
    - master

steps:
  - name: Publish
    image: quay.io/natlibfi/drone-npm-git-publish
    settings:
      git_user_name: natlibfi-melinda-automation
      git_user_email: 65649125+natlibfi-melinda-automation@users.noreply.github.com
      git_ssh_key:
        from_secret: ssh_key
      git_gpg_key:
        from_secret: gpg_key
---
kind: secret
name: npm_token
data: OVu9DBF0dpZvm5EX+QIGPNtx5ddG0sFOzrEtYhLcpezfbtG928vQrSAxrjF8HusBR04pEWwTnYtznuSTKEbm+w==
---
kind: secret
name: ssh_key
data: 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
---
kind: secret
name: gpg_key
data: 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
---
kind: signature
hmac: 91ef57226603bedbd0d171d4e24ecce71cc7d4334be76b4526e27f62f8219be6

...
